<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #a5b4fc;
      --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-secondary: #64748b;
      --border: #e2e8f0; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
      --favorite: #fbbf24;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: calc(70px + var(--safe-bottom)); overflow-x: hidden; }
    
    .header { position: fixed; top: 0; left: 0; right: 0; z-index: 120; background: var(--primary); color: white; padding: 12px 16px; padding-top: calc(12px + env(safe-area-inset-top)); display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 18px; font-weight: 600; }
    .header-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.15); }
    
    .main { padding-top: calc(64px + env(safe-area-inset-top)); padding-bottom: 80px; }
    .screen { display: none; animation: fadeIn 0.2s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .search-bar { padding: 12px 16px; position: sticky; top: calc(64px + env(safe-area-inset-top)); background: var(--bg); z-index: 40; }
    .search-input { width: 100%; padding: 12px 16px 12px 44px; border: none; border-radius: 12px; background: var(--card); font-size: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .search-input:focus { outline: 2px solid var(--primary); }
    .search-icon { position: absolute; left: 28px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
    
    .filter-chips { display: flex; gap: 8px; padding: 0 16px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .filter-chips::-webkit-scrollbar { display: none; }
    .chip { padding: 8px 16px; border-radius: 20px; background: var(--card); border: 1.5px solid var(--border); font-size: 14px; white-space: nowrap; transition: all 0.2s; }
    .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .card-list { padding: 0 16px; display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
    .card.favorite { border: 2px solid var(--favorite); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .card-title { font-size: 17px; font-weight: 600; }
    .favorite-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 500; background: #fef3c7; color: #b45309; margin-left: 8px; }
    .card-badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 500; }
    .badge-appearance { background: #fce7f3; color: #be185d; }
    .badge-personality { background: #dbeafe; color: #1d4ed8; }
    .badge-behavior { background: #fef3c7; color: #b45309; }
    .badge-age { background: #ede9fe; color: #6d28d9; }
    .badge-restriction { background: #fee2e2; color: #dc2626; }
    .badge-other { background: #e5e7eb; color: #4b5563; }
    .card-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .card-note { font-size: 13px; color: var(--warning); margin-top: 8px; font-style: italic; }
    .card-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .card-btn { flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-edit { background: #fef3c7; color: #b45309; }
    .btn-delete { background: #fee2e2; color: #dc2626; }
    .btn-detail { background: #dbeafe; color: #1d4ed8; }
    .btn-copy { background: #d1fae5; color: #059669; }
    .btn-favorite { background: #fef3c7; color: #b45309; }
    .btn-apply { background: #e0e7ff; color: #4f46e5; }
    
    .char-parts { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    .char-tag { padding: 4px 10px; background: var(--bg); border-radius: 8px; font-size: 12px; color: var(--text-secondary); }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); display: flex; padding-bottom: var(--safe-bottom); z-index: 150; }
    .nav-item { flex: 1; padding: 12px 0 8px; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-secondary); text-decoration: none; font-size: 11px; transition: color 0.2s; }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 22px; }
    
    .fab { position: fixed; bottom: calc(85px + var(--safe-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 16px; background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(99,102,241,0.4); display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 140; transition: transform 0.2s, box-shadow 0.2s; }
    .fab:active { transform: scale(0.95); }
    
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-radius: 24px 24px 0 0; z-index: 201; transform: translateY(100%); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
    .bottom-sheet.active { transform: translateY(0); }
    .sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .sheet-header { padding: 0 20px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .sheet-title { font-size: 18px; font-weight: 600; }
    .sheet-close { width: 32px; height: 32px; border: none; background: var(--bg); border-radius: 50%; font-size: 18px; color: var(--text-secondary); }
    .sheet-body { padding: 20px; overflow-y: auto; flex: 1; padding-bottom: calc(20px + var(--safe-bottom)); }
    
    .form-group { margin-bottom: 20px; position: relative; }
    .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--text); }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border: 1.5px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--card); transition: border-color 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
    .form-textarea { resize: none; min-height: 100px; }
    .clear-btn { position: absolute; right: 8px; top: 38px; padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; color: var(--text-secondary); cursor: pointer; }
    .clear-btn:hover { background: var(--border); }
    
    .checkbox-list { display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto; padding: 4px; }
    .checkbox-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 10px; }
    .checkbox-item input { width: 20px; height: 20px; accent-color: var(--primary); }
    
    .btn-primary { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; }
    .btn-primary:active { background: var(--primary-dark); }
    
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state p { font-size: 15px; }
    
    .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); display: flex; align-items: center; justify-content: center; z-index: 500; padding: 20px; }
    .login-box { background: white; border-radius: 24px; padding: 32px 24px; width: 100%; max-width: 360px; }
    .login-logo { text-align: center; font-size: 48px; margin-bottom: 8px; }
    .login-title { text-align: center; font-size: 22px; font-weight: 600; margin-bottom: 24px; }
    .login-error { color: var(--danger); font-size: 14px; text-align: center; margin-top: 12px; min-height: 20px; }
    
    .detail-text { width: 100%; min-height: 300px; padding: 16px; background: var(--bg); border: none; border-radius: 12px; font-family: monospace; font-size: 14px; line-height: 1.6; resize: none; }
    
    .toast { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text); color: white; padding: 14px 24px; border-radius: 12px; font-size: 14px; z-index: 300; opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <div class="login-logo">ğŸ­</div>
      <h1 class="login-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</h1>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
          <input type="text" class="form-input" id="loginUser" required>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" class="form-input" id="loginPass" required>
        </div>
        <button type="submit" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p class="login-error" id="loginError"></p>
      </form>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
  <div id="app" style="display:none;">
    <header class="header">
      <h1>ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</h1>
      <div class="header-icon"><i class="fas fa-user"></i></div>
    </header>

    <main class="main">
      <!-- ãƒ‘ãƒ¼ãƒ„ç”»é¢ -->
      <div class="screen active" id="partsScreen">
        <div class="search-bar">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" placeholder="ãƒ‘ãƒ¼ãƒ„ã‚’æ¤œç´¢..." id="partsSearch">
        </div>
        <div class="filter-chips" id="partFilters">
          <button class="chip active" data-type="all">ã™ã¹ã¦</button>
          <button class="chip" data-type="appearance">å®¹å§¿</button>
          <button class="chip" data-type="personality">æ€§æ ¼</button>
          <button class="chip" data-type="behavior">è¡Œå‹•</button>
          <button class="chip" data-type="age">å¹´ä»£</button>
          <button class="chip" data-type="restriction">åˆ¶é™</button>
          <button class="chip" data-type="other">ãã®ä»–</button>
        </div>
        <div class="card-list" id="partsList"></div>
      </div>

      <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»é¢ -->
      <div class="screen" id="charsScreen">
        <div class="search-bar">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ¤œç´¢..." id="charsSearch">
        </div>
        <div class="card-list" id="charsList"></div>
      </div>

      <!-- ãŠæ°—ã«å…¥ã‚Šç”»é¢ -->
      <div class="screen" id="favoritesScreen">
        <div class="search-bar">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" placeholder="ãŠæ°—ã«å…¥ã‚Šã‚’æ¤œç´¢..." id="favoritesSearch">
        </div>
        <div class="card-list" id="favoritesList"></div>
      </div>
    </main>

    <!-- FAB -->
    <button class="fab" id="fabBtn"><i class="fas fa-plus"></i></button>

    <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ -->
    <nav class="bottom-nav">
      <a href="#" class="nav-item active" data-screen="parts"><i class="fas fa-puzzle-piece"></i><span>ãƒ‘ãƒ¼ãƒ„</span></a>
      <a href="#" class="nav-item" data-screen="chars"><i class="fas fa-users"></i><span>ã‚­ãƒ£ãƒ©</span></a>
      <a href="#" class="nav-item" data-screen="favorites"><i class="fas fa-star"></i><span>ä¿å­˜æ¸ˆã¿</span></a>
    </nav>
  </div>

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="overlay" id="overlay"></div>

  <!-- ãƒ‘ãƒ¼ãƒ„ä½œæˆã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="partSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="partSheetTitle">ãƒ‘ãƒ¼ãƒ„ä½œæˆ</span>
      <button class="sheet-close" onclick="closeSheet('partSheet')">Ã—</button>
    </div>
    <div class="sheet-body">
      <form id="partForm">
        <div class="form-group">
          <label class="form-label">ç¨®åˆ¥</label>
          <select class="form-select" id="partType" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="appearance">å®¹å§¿</option>
            <option value="personality">æ€§æ ¼</option>
            <option value="behavior">è¡Œå‹•</option>
            <option value="age">å¹´ä»£</option>
            <option value="restriction">åˆ¶é™</option>
            <option value="other">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">åå‰</label>
          <input type="text" class="form-input" id="partName" required placeholder="ä¾‹: é»’é«ªãƒ­ãƒ³ã‚°">
        </div>
        <div class="form-group">
          <label class="form-label">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
          <button type="button" class="clear-btn" onclick="clearPartDesc()"><i class="fas fa-times"></i> ã‚¯ãƒªã‚¢</button>
          <textarea class="form-textarea" id="partDesc" placeholder="è©³ç´°ãªèª¬æ˜"></textarea>
        </div>
        <button type="submit" class="btn-primary">ä¿å­˜</button>
      </form>
    </div>
  </div>

  <!-- ã‚­ãƒ£ãƒ©ä½œæˆã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="charSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="charSheetTitle">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ</span>
      <button class="sheet-close" onclick="closeSheet('charSheet')">Ã—</button>
    </div>
    <div class="sheet-body">
      <form id="charForm">
        <div class="form-group">
          <label class="form-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</label>
          <input type="text" class="form-input" id="charName" required placeholder="ä¾‹: å‹‡è€…ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹">
        </div>
        <div class="form-group">
          <label class="form-label">å®¹å§¿ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charAppearance"></div>
        </div>
        <div class="form-group">
          <label class="form-label">æ€§æ ¼ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charPersonality"></div>
        </div>
        <div class="form-group">
          <label class="form-label">å¹´ä»£ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charAge"></div>
        </div>
        <div class="form-group">
          <label class="form-label">è¡Œå‹•ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charBehaviors"></div>
        </div>
        <div class="form-group">
          <label class="form-label">åˆ¶é™ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charRestrictions"></div>
        </div>
        <div class="form-group">
          <label class="form-label">ãã®ä»–ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="checkbox-list" id="charOthers"></div>
        </div>
        <button type="submit" class="btn-primary">ä¿å­˜</button>
      </form>
    </div>
  </div>

  <!-- ãŠæ°—ã«å…¥ã‚Šä¿å­˜ã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="favoriteSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title">ãŠæ°—ã«å…¥ã‚Šã¨ã—ã¦ä¿å­˜</span>
      <button class="sheet-close" onclick="closeSheet('favoriteSheet')">Ã—</button>
    </div>
    <div class="sheet-body">
      <form id="favoriteForm">
        <div class="form-group">
          <label class="form-label">ä¿å­˜åï¼ˆçœç•¥å¯ï¼‰</label>
          <input type="text" class="form-input" id="favoriteName" placeholder="ä¾‹: åˆæœŸè¨­å®šã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³2ãªã©">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆçœç•¥å¯ï¼‰</label>
          <textarea class="form-textarea" id="favoriteNote" placeholder="ã“ã®è¨­å®šã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢" style="min-height: 80px;"></textarea>
        </div>
        <button type="submit" class="btn-primary"><i class="fas fa-star"></i> ä¿å­˜</button>
      </form>
    </div>
  </div>

  <!-- è©³ç´°ã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="detailSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="detailTitle">è©³ç´°</span>
      <button class="sheet-close" onclick="closeSheet('detailSheet')">Ã—</button>
    </div>
    <div class="sheet-body">
      <textarea class="detail-text" id="detailText" readonly></textarea>
      <button class="btn-primary" onclick="copyDetail()"><i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="toast" id="toast"></div>

<script>
const API_BASE_URL = 'https://5moouwqlbi.execute-api.ap-northeast-1.amazonaws.com/prod';
let authHeader = '', allParts = [], allCharacters = [], allFavorites = [], currentFilter = 'all', currentScreen = 'parts', editingPartId = null, editingCharacterId = null, savingFavoriteFromId = null;

// åˆæœŸåŒ–
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const user = document.getElementById('loginUser').value;
  const pass = document.getElementById('loginPass').value;
  authHeader = 'Basic ' + btoa(user + ':' + pass);
  try {
    const res = await fetch(`${API_BASE_URL}/parts`, { headers: { 'Authorization': authHeader } });
    if (res.ok) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      initApp();
    } else {
      document.getElementById('loginError').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
      authHeader = '';
    }
  } catch { document.getElementById('loginError').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼'; authHeader = ''; }
});

async function initApp() {
  await Promise.all([loadParts(), loadCharacters(), loadFavorites()]);
  renderParts(); renderCharacters(); renderFavorites();
  setupEvents();
}

function setupEvents() {
  document.querySelectorAll('.nav-item').forEach(n => {
    n.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const targetScreen = this.dataset.screen;
      
      // å…¨ã¦ã®ã‚¿ãƒ–ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      this.classList.add('active');
      document.getElementById(targetScreen + 'Screen').classList.add('active');
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
      currentScreen = targetScreen;
    });
  });
  
  document.querySelectorAll('#partFilters .chip').forEach(c => c.addEventListener('click', () => {
    document.querySelectorAll('#partFilters .chip').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    currentFilter = c.dataset.type;
    renderParts();
  }));
  
  document.getElementById('partsSearch').addEventListener('input', renderParts);
  document.getElementById('charsSearch').addEventListener('input', renderCharacters);
  document.getElementById('favoritesSearch').addEventListener('input', renderFavorites);
  document.getElementById('fabBtn').addEventListener('click', () => {
    if (currentScreen === 'parts') openPartSheet();
    else if (currentScreen === 'chars') openCharSheet();
    else toast('ãŠæ°—ã«å…¥ã‚Šã¯æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ä¿å­˜ã§ãã¾ã™');
  });
  document.getElementById('overlay').addEventListener('click', closeAllSheets);
  document.getElementById('partForm').addEventListener('submit', handlePartSubmit);
  document.getElementById('charForm').addEventListener('submit', handleCharSubmit);
  document.getElementById('favoriteForm').addEventListener('submit', handleFavoriteSubmit);
}

async function loadParts() {
  try {
    const res = await fetch(`${API_BASE_URL}/parts`, { headers: { 'Authorization': authHeader } });
    const data = await res.json();
    allParts = data.parts || [];
  } catch (e) { console.error(e); }
}

async function loadCharacters() {
  try {
    const res = await fetch(`${API_BASE_URL}/characters`, { headers: { 'Authorization': authHeader } });
    const data = await res.json();
    allCharacters = (data.characters || []).filter(c => !c.IsFavorite);
  } catch (e) { console.error(e); }
}

async function loadFavorites() {
  try {
    const res = await fetch(`${API_BASE_URL}/characters?favorites=true`, { headers: { 'Authorization': authHeader } });
    const data = await res.json();
    allFavorites = data.characters || [];
  } catch (e) { console.error(e); }
}

function renderParts() {
  const search = document.getElementById('partsSearch').value.toLowerCase();
  let filtered = allParts;
  if (currentFilter !== 'all') filtered = filtered.filter(p => p.PartType === currentFilter);
  if (search) filtered = filtered.filter(p => p.Name.toLowerCase().includes(search) || (p.Description || '').toLowerCase().includes(search));
  
  const container = document.getElementById('partsList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-puzzle-piece"></i><p>ãƒ‘ãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }
  container.innerHTML = filtered.map(p => `
    <div class="card">
      <div class="card-header">
        <span class="card-title">${esc(p.Name)}</span>
        <span class="card-badge badge-${p.PartType}">${typeLabel(p.PartType)}</span>
      </div>
      ${p.Description ? `<p class="card-desc">${esc(p.Description)}</p>` : ''}
      <div class="card-actions">
        <button class="card-btn btn-edit" onclick="editPart('${p.PartID}')"><i class="fas fa-edit"></i> ç·¨é›†</button>
        <button class="card-btn btn-delete" onclick="deletePart('${p.PartID}')"><i class="fas fa-trash"></i> å‰Šé™¤</button>
      </div>
    </div>
  `).join('');
}

function renderCharacters() {
  const search = document.getElementById('charsSearch').value.toLowerCase();
  let filtered = allCharacters;
  if (search) filtered = filtered.filter(c => c.CharacterName.toLowerCase().includes(search));
  
  const container = document.getElementById('charsList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }
  container.innerHTML = filtered.map(c => {
    const parts = c.parts || {};
    let tags = '';
    if (parts.Appearances?.length) parts.Appearances.forEach(a => tags += `<span class="char-tag">${esc(a.Name)}</span>`);
    if (parts.Personalities?.length) parts.Personalities.forEach(per => tags += `<span class="char-tag">${esc(per.Name)}</span>`);
    if (parts.Ages?.length) parts.Ages.forEach(a => tags += `<span class="char-tag">${esc(a.Name)}</span>`);
    return `
      <div class="card">
        <div class="card-header"><span class="card-title">${esc(c.CharacterName)}</span></div>
        <div class="char-parts">${tags}</div>
        <div class="card-actions">
          <button class="card-btn btn-detail" onclick="showDetail('${c.CharacterID}')"><i class="fas fa-eye"></i></button>
          <button class="card-btn btn-copy" onclick="copyChar('${c.CharacterID}')"><i class="fas fa-copy"></i></button>
          <button class="card-btn btn-favorite" onclick="openFavoriteSheet('${c.CharacterID}')"><i class="fas fa-star"></i> ä¿å­˜</button>
          <button class="card-btn btn-edit" onclick="editChar('${c.CharacterID}')"><i class="fas fa-edit"></i></button>
          <button class="card-btn btn-delete" onclick="deleteChar('${c.CharacterID}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
  }).join('');
}

function renderFavorites() {
  const search = document.getElementById('favoritesSearch').value.toLowerCase();
  let filtered = allFavorites;
  if (search) filtered = filtered.filter(c => c.CharacterName.toLowerCase().includes(search) || (c.FavoriteNote || '').toLowerCase().includes(search));
  
  const container = document.getElementById('favoritesList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-star"></i><p>ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p><p style="margin-top:8px;font-size:13px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»é¢ã‹ã‚‰ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã§ãã¾ã™</p></div>';
    return;
  }
  container.innerHTML = filtered.map(c => {
    const parts = c.parts || {};
    let tags = '';
    if (parts.Appearances?.length) parts.Appearances.forEach(a => tags += `<span class="char-tag">${esc(a.Name)}</span>`);
    if (parts.Personalities?.length) parts.Personalities.forEach(per => tags += `<span class="char-tag">${esc(per.Name)}</span>`);
    if (parts.Ages?.length) parts.Ages.forEach(a => tags += `<span class="char-tag">${esc(a.Name)}</span>`);
    const date = new Date(c.CreatedAt).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    return `
      <div class="card favorite">
        <div class="card-header">
          <span class="card-title">${esc(c.CharacterName)}<span class="favorite-badge"><i class="fas fa-star"></i> ä¿å­˜æ¸ˆã¿</span></span>
        </div>
        <div class="char-parts">${tags}</div>
        ${c.FavoriteNote ? `<p class="card-note"><i class="fas fa-sticky-note"></i> ${esc(c.FavoriteNote)}</p>` : ''}
        <p style="font-size:12px;color:var(--text-secondary);margin-top:8px;">ä¿å­˜æ—¥æ™‚: ${date}</p>
        <div class="card-actions">
          <button class="card-btn btn-detail" onclick="showDetail('${c.CharacterID}')"><i class="fas fa-eye"></i></button>
          <button class="card-btn btn-copy" onclick="copyChar('${c.CharacterID}')"><i class="fas fa-copy"></i></button>
          <button class="card-btn btn-apply" onclick="applyFavorite('${c.CharacterID}')"><i class="fas fa-download"></i> é©ç”¨</button>
          <button class="card-btn btn-delete" onclick="deleteFavorite('${c.CharacterID}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
  }).join('');
}

function openPartSheet(id = null) {
  editingPartId = id;
  document.getElementById('partForm').reset();
  document.getElementById('partSheetTitle').textContent = id ? 'ãƒ‘ãƒ¼ãƒ„ç·¨é›†' : 'ãƒ‘ãƒ¼ãƒ„ä½œæˆ';
  if (id) {
    const p = allParts.find(x => x.PartID === id);
    if (p) {
      document.getElementById('partType').value = p.PartType;
      document.getElementById('partName').value = p.Name;
      document.getElementById('partDesc').value = p.Description || '';
    }
  }
  openSheet('partSheet');
}

function clearPartDesc() {
  document.getElementById('partDesc').value = '';
  toast('èª¬æ˜æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

function openCharSheet(id = null) {
  editingCharacterId = id;
  document.getElementById('charForm').reset();
  document.getElementById('charSheetTitle').textContent = id ? 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†' : 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ';
  
  // ã¾ãšãƒ‘ãƒ¼ãƒ„ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
  populateCharSelects();
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  if (id) {
    setTimeout(() => {
      const c = allCharacters.find(x => x.CharacterID === id);
      if (c) {
        document.getElementById('charName').value = c.CharacterName;
        
        // å„ãƒ‘ãƒ¼ãƒ„ã®è¨­å®š
        const partTypes = [
          { ids: c.AppearancePartIDs || [], selector: '#charAppearance' },
          { ids: c.PersonalityPartIDs || [], selector: '#charPersonality' },
          { ids: c.AgePartIDs || [], selector: '#charAge' },
          { ids: c.BehaviorPartIDs || [], selector: '#charBehaviors' },
          { ids: c.RestrictionPartIDs || [], selector: '#charRestrictions' },
          { ids: c.OtherPartIDs || [], selector: '#charOthers' }
        ];
        
        partTypes.forEach(({ ids, selector }) => {
          ids.forEach(partId => {
            const cb = document.querySelector(`${selector} input[type="checkbox"][value="${partId}"]`);
            if (cb) cb.checked = true;
          });
        });
      }
    }, 100);
  }
  
  openSheet('charSheet');
}

function openFavoriteSheet(characterId) {
  savingFavoriteFromId = characterId;
  document.getElementById('favoriteForm').reset();
  const c = allCharacters.find(x => x.CharacterID === characterId);
  if (c) {
    document.getElementById('favoriteName').value = c.CharacterName + ' - ã‚³ãƒ”ãƒ¼';
  }
  openSheet('favoriteSheet');
}

function populateCharSelects() {
  ['charAppearance:appearance', 'charPersonality:personality', 'charAge:age', 'charBehaviors:behavior', 'charRestrictions:restriction', 'charOthers:other'].forEach(s => {
    const [id, type] = s.split(':');
    const div = document.getElementById(id);
    const parts = allParts.filter(p => p.PartType === type);
    
    if (parts.length === 0) {
      div.innerHTML = '<p style="color:var(--text-secondary);font-size:13px;">ãƒ‘ãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    } else {
      div.innerHTML = parts.map(p => `<label class="checkbox-item"><input type="checkbox" value="${p.PartID}">${esc(p.Name)}</label>`).join('');
    }
  });
}

function openSheet(id) {
  document.getElementById('overlay').classList.add('active');
  document.getElementById(id).classList.add('active');
}

function closeSheet(id) {
  document.getElementById('overlay').classList.remove('active');
  document.getElementById(id).classList.remove('active');
}

function closeAllSheets() {
  document.getElementById('overlay').classList.remove('active');
  document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
}

async function handlePartSubmit(e) {
  e.preventDefault();
  const data = { PartType: document.getElementById('partType').value, Name: document.getElementById('partName').value, Description: document.getElementById('partDesc').value };
  try {
    const url = editingPartId ? `${API_BASE_URL}/parts/${editingPartId}` : `${API_BASE_URL}/parts`;
    const method = editingPartId ? 'PUT' : 'POST';
    await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify(data) });
    await loadParts(); renderParts(); closeAllSheets();
    toast(editingPartId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ä½œæˆã—ã¾ã—ãŸ');
  } catch { toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
}

async function handleCharSubmit(e) {
  e.preventDefault();
  
  const data = {
    CharacterName: document.getElementById('charName').value,
    AppearancePartIDs: [...document.querySelectorAll('#charAppearance input:checked')].map(c => c.value),
    PersonalityPartIDs: [...document.querySelectorAll('#charPersonality input:checked')].map(c => c.value),
    AgePartIDs: [...document.querySelectorAll('#charAge input:checked')].map(c => c.value),
    BehaviorPartIDs: [...document.querySelectorAll('#charBehaviors input:checked')].map(c => c.value),
    RestrictionPartIDs: [...document.querySelectorAll('#charRestrictions input:checked')].map(c => c.value),
    OtherPartIDs: [...document.querySelectorAll('#charOthers input:checked')].map(c => c.value)
  };
  
  try {
    const url = editingCharacterId ? `${API_BASE_URL}/characters/${editingCharacterId}` : `${API_BASE_URL}/characters`;
    const method = editingCharacterId ? 'PUT' : 'POST';
    await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': authHeader }, body: JSON.stringify(data) });
    await loadCharacters(); renderCharacters(); closeAllSheets();
    toast(editingCharacterId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ä½œæˆã—ã¾ã—ãŸ');
  } catch { toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
}

async function handleFavoriteSubmit(e) {
  e.preventDefault();
  if (!savingFavoriteFromId) return;
  
  const original = allCharacters.find(c => c.CharacterID === savingFavoriteFromId);
  if (!original) return;
  
  const favName = document.getElementById('favoriteName').value || original.CharacterName;
  const favNote = document.getElementById('favoriteNote').value;
  
  const data = {
    CharacterName: favName,
    AppearancePartIDs: original.AppearancePartIDs || [],
    PersonalityPartIDs: original.PersonalityPartIDs || [],
    AgePartIDs: original.AgePartIDs || [],
    BehaviorPartIDs: original.BehaviorPartIDs || [],
    RestrictionPartIDs: original.RestrictionPartIDs || [],
    OtherPartIDs: original.OtherPartIDs || [],
    IsFavorite: true,
    FavoriteNote: favNote
  };
  
  try {
    await fetch(`${API_BASE_URL}/characters`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
      body: JSON.stringify(data)
    });
    await loadFavorites(); renderFavorites(); closeAllSheets();
    toast('ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜ã—ã¾ã—ãŸ');
  } catch { toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
}

async function applyFavorite(favoriteId) {
  if (!confirm('ã“ã®ãŠæ°—ã«å…¥ã‚Šã®è¨­å®šã‚’æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  const fav = allFavorites.find(f => f.CharacterID === favoriteId);
  if (!fav) return;
  
  const data = {
    CharacterName: fav.CharacterName.replace(' - ã‚³ãƒ”ãƒ¼', '').replace('ï¼ˆä¿å­˜ï¼‰', '') + ' - å¾©å…ƒ',
    AppearancePartIDs: fav.AppearancePartIDs || [],
    PersonalityPartIDs: fav.PersonalityPartIDs || [],
    AgePartIDs: fav.AgePartIDs || [],
    BehaviorPartIDs: fav.BehaviorPartIDs || [],
    RestrictionPartIDs: fav.RestrictionPartIDs || [],
    OtherPartIDs: fav.OtherPartIDs || [],
    IsFavorite: false
  };
  
  try {
    await fetch(`${API_BASE_URL}/characters`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
      body: JSON.stringify(data)
    });
    await loadCharacters(); renderCharacters();
    toast('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector('.nav-item[data-screen="chars"]').classList.add('active');
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('charsScreen').classList.add('active');
    currentScreen = 'chars';
  } catch { toast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
}

function editPart(id) { openPartSheet(id); }
function editChar(id) { openCharSheet(id); }

async function deletePart(id) {
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await fetch(`${API_BASE_URL}/parts/${id}`, { method: 'DELETE', headers: { 'Authorization': authHeader } });
  await loadParts(); renderParts(); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

async function deleteChar(id) {
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await fetch(`${API_BASE_URL}/characters/${id}`, { method: 'DELETE', headers: { 'Authorization': authHeader } });
  await loadCharacters(); renderCharacters(); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

async function deleteFavorite(id) {
  if (!confirm('ã“ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await fetch(`${API_BASE_URL}/characters/${id}`, { method: 'DELETE', headers: { 'Authorization': authHeader } });
  await loadFavorites(); renderFavorites(); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function showDetail(id) {
  const c = [...allCharacters, ...allFavorites].find(x => x.CharacterID === id);
  if (!c) return;
  document.getElementById('detailTitle').textContent = c.CharacterName;
  document.getElementById('detailText').value = genCharText(c);
  openSheet('detailSheet');
}

function copyChar(id) {
  const c = [...allCharacters, ...allFavorites].find(x => x.CharacterID === id);
  if (!c) return;
  const text = genCharText(c);
  
  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(() => {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function copyDetail() {
  const text = document.getElementById('detailText').value;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(() => {
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  textarea.style.top = '0';
  textarea.style.left = '0';
  document.body.appendChild(textarea);
  textarea.focus();
  textarea.select();
  
  try {
    document.execCommand('copy');
    toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch (err) {
    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
    toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
  
  document.body.removeChild(textarea);
}

function genCharText(c) {
  const p = c.parts || {};
  let t = `# ${c.CharacterName}\n\n`;
  if (p.Appearances?.length) {
    t += `## å®¹å§¿\n${p.Appearances.map(a => `- ${a.Name}${a.Description ? ' - ' + a.Description : ''}`).join('\n')}\n\n`;
  }
  if (p.Personalities?.length) {
    t += `## æ€§æ ¼\n${p.Personalities.map(per => `- ${per.Name}${per.Description ? ' - ' + per.Description : ''}`).join('\n')}\n\n`;
  }
  if (p.Ages?.length) {
    t += `## å¹´ä»£\n${p.Ages.map(a => `- ${a.Name}${a.Description ? ' - ' + a.Description : ''}`).join('\n')}\n\n`;
  }
  if (p.Behaviors?.length) t += `## è¡Œå‹•\n${p.Behaviors.map(b => `- ${b.Name}${b.Description ? ' - ' + b.Description : ''}`).join('\n')}\n\n`;
  if (p.Restrictions?.length) t += `## åˆ¶é™\n${p.Restrictions.map(r => `- ${r.Name}${r.Description ? ' - ' + r.Description : ''}`).join('\n')}\n\n`;
  if (p.Others?.length) t += `## ãã®ä»–\n${p.Others.map(o => `- ${o.Name}${o.Description ? ' - ' + o.Description : ''}`).join('\n')}\n\n`;
  return t.trim();
}

function typeLabel(t) { return { appearance: 'å®¹å§¿', personality: 'æ€§æ ¼', behavior: 'è¡Œå‹•', age: 'å¹´ä»£', restriction: 'åˆ¶é™', other: 'ãã®ä»–' }[t] || t; }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
</script>
</body>
</html>